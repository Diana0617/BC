# üìÖ Sistema de Calendario - Progreso de Implementaci√≥n

## ‚úÖ FASE 1 COMPLETADA: Backend Core

### Archivos Creados

#### 1. **AvailabilityService.js** ‚úÖ
**Ubicaci√≥n**: `packages/backend/src/services/AvailabilityService.js`

**Funciones principales**:
- ‚úÖ `generateAvailableSlots()` - Genera slots disponibles para un d√≠a espec√≠fico
  - Valida horarios de sucursal (Branch.businessHours)
  - Valida disponibilidad del especialista (SpecialistBranchSchedule)
  - Calcula intersecci√≥n de horarios
  - Obtiene duraci√≥n del servicio
  - Excluye citas existentes
  - Retorna slots disponibles con metadata completa

- ‚úÖ `getAvailabilityRange()` - Disponibilidad de m√∫ltiples d√≠as
  - Rango de fechas (startDate ‚Üí endDate)
  - Retorna solo d√≠as con slots disponibles

- ‚úÖ `getAvailableSpecialists()` - Especialistas disponibles para fecha/hora
  - Dado un servicio, fecha y hora espec√≠ficos
  - Retorna lista de especialistas sin conflictos

- ‚úÖ `validateSlotAvailability()` - Validar slot antes de crear cita
  - Verifica que no haya conflictos
  - √ötil para validaci√≥n previa a reserva

**Helpers implementados**:
- `generateTimeSlots()` - Genera slots en rango horario
- `isSlotOccupied()` - Detecta solapamiento de citas
- `getDayOfWeekName()` - Convierte fecha a nombre de d√≠a
- `parseTime()`, `formatTime()` - Manejo de horas
- `addMinutes()` - Suma minutos a Date
- `maxTime()`, `minTime()` - Comparaci√≥n de horarios
- `getDateRange()` - Array de fechas entre dos fechas

**L√≥gica de negocio clave**:
```javascript
// Intersecci√≥n de horarios (lo m√°s restrictivo gana)
workStart = max(branchHours.open, specialistSchedule.startTime)
workEnd = min(branchHours.close, specialistSchedule.endTime)

// Slots = Dividir rango en intervalos de X minutos (duraci√≥n del servicio)
// Filtrar = Excluir slots con citas existentes (CONFIRMED, IN_PROGRESS, etc.)
```

---

#### 2. **CalendarController.js** ‚úÖ
**Ubicaci√≥n**: `packages/backend/src/controllers/CalendarController.js`

**Endpoints implementados**:

##### `getBusinessCalendar()` - Vista completa del negocio
- **Ruta**: `GET /api/calendar/business/:businessId`
- **Roles**: OWNER, BUSINESS_ADMIN
- **Par√°metros**:
  - `startDate` (required): YYYY-MM-DD
  - `endDate` (required): YYYY-MM-DD
  - `branchId` (optional): Filtrar por sucursal
  - `specialistId` (optional): Filtrar por especialista
  - `status` (optional): Filtrar por estado
- **Retorna**:
  ```javascript
  {
    events: [{ id, title, start, end, status, backgroundColor, extendedProps }],
    stats: {
      total, 
      byStatus: { PENDING: 5, CONFIRMED: 10, ... },
      byBranch: { "Sucursal Centro": 8, ... },
      totalRevenue: 1250000
    },
    dateRange: { startDate, endDate }
  }
  ```

##### `getBranchCalendar()` - Vista de sucursal
- **Ruta**: `GET /api/calendar/branch/:branchId`
- **Roles**: OWNER, BUSINESS_ADMIN, RECEPTIONIST, SPECIALIST_RECEPTIONIST
- **Par√°metros**:
  - `startDate` (required)
  - `endDate` (required)
  - `specialistId` (optional)
  - `status` (optional)
- **Retorna**: Eventos + metadata de sucursal

##### `getSpecialistCombinedCalendar()` - Agenda combinada
- **Ruta**: `GET /api/calendar/specialist/:specialistId`
- **Roles**: OWNER, BUSINESS_ADMIN, SPECIALIST, SPECIALIST_RECEPTIONIST
- **Par√°metros**:
  - `startDate` (required)
  - `endDate` (required)
  - `branchId` (optional): Filtrar por sucursal espec√≠fica
  - `status` (optional)
- **Retorna**: Todas las citas del especialista en todas sus sucursales
- **Incluye**: Agrupaci√≥n por sucursal (byBranch)

##### `getAvailableSlots()` - Slots disponibles
- **Ruta**: `GET /api/calendar/available-slots`
- **Roles**: Puede ser p√∫blica (para reserva online)
- **Par√°metros**:
  - `businessId` (required)
  - `branchId` (required)
  - `specialistId` (required)
  - `serviceId` (required)
  - `date` (required): YYYY-MM-DD
- **Retorna**:
  ```javascript
  {
    date: "2024-01-15",
    dayOfWeek: "monday",
    branch: { id, name, hours },
    specialist: { id, name, schedule },
    service: { id, name, duration, price },
    workingHours: { start: "09:00", end: "18:00" },
    totalSlots: 18,
    availableSlots: 12,
    occupiedSlots: 6,
    slots: [
      { startTime: "09:00", endTime: "10:00", available: true },
      { startTime: "10:00", endTime: "11:00", available: true },
      ...
    ]
  }
  ```

##### `getAvailabilityRange()` - Rango de disponibilidad
- **Ruta**: `GET /api/calendar/availability-range`
- **Par√°metros**:
  - Todos los de `available-slots` +
  - `startDate` y `endDate` en lugar de `date`
- **Retorna**: Array de disponibilidad por d√≠a (solo d√≠as con slots)

##### `getBranchSpecialists()` - Especialistas de sucursal
- **Ruta**: `GET /api/calendar/branch/:branchId/specialists`
- **Par√°metros opcionales**:
  - `serviceId`: Para filtrar por servicio
  - `date`: YYYY-MM-DD
  - `time`: HH:MM
- **Comportamiento**:
  - **Con serviceId, date, time**: Retorna solo especialistas disponibles en ese horario
  - **Sin par√°metros**: Retorna todos los especialistas de la sucursal
- **Retorna**:
  ```javascript
  {
    specialists: [
      {
        id, firstName, lastName, email,
        specialization, bio,
        schedule: { startTime, endTime }, // Si se pidi√≥ para horario espec√≠fico
        available: true
      }
    ],
    total: 3
  }
  ```

**Helper**:
- `getStatusColor(status)` - Mapeo de colores para calendario
  - PENDING: #FFA500 (Naranja)
  - CONFIRMED: #4CAF50 (Verde)
  - IN_PROGRESS: #2196F3 (Azul)
  - COMPLETED: #9E9E9E (Gris)
  - CANCELED: #F44336 (Rojo)
  - NO_SHOW: #FF6347 (Rojo tomate)
  - RESCHEDULED: #FFD700 (Dorado)

---

#### 3. **calendar.js** (Routes) ‚úÖ
**Ubicaci√≥n**: `packages/backend/src/routes/calendar.js`

**Rutas registradas**:
```javascript
router.get('/business/:businessId', authorizeRole(['OWNER', 'BUSINESS_ADMIN']), ...)
router.get('/branch/:branchId', authorizeRole(['OWNER', 'BUSINESS_ADMIN', 'RECEPTIONIST', 'SPECIALIST_RECEPTIONIST']), ...)
router.get('/specialist/:specialistId', authorizeRole(['OWNER', 'BUSINESS_ADMIN', 'SPECIALIST', 'SPECIALIST_RECEPTIONIST']), ...)
router.get('/available-slots', ...) // Puede ser p√∫blica
router.get('/availability-range', ...)
router.get('/branch/:branchId/specialists', ...)
```

**Todas las rutas**:
- ‚úÖ Requieren autenticaci√≥n (`authenticateToken`)
- ‚úÖ Tienen control de roles espec√≠fico por vista
- ‚úÖ Documentadas con JSDoc/comentarios

---

#### 4. **app.js** (Actualizado) ‚úÖ
**Ubicaci√≥n**: `packages/backend/src/app.js`

**Cambios**:
```javascript
// L√≠nea ~220 - Import
const calendarRoutes = require('./routes/calendar');

// L√≠nea ~237 - Registro de ruta
app.use('/api/calendar', calendarRoutes);
```

---

## üéØ Funcionalidades Implementadas

### ‚úÖ C√°lculo de Disponibilidad
- [x] Intersecci√≥n de horarios (sucursal + especialista)
- [x] Generaci√≥n de slots basada en duraci√≥n de servicio
- [x] Exclusi√≥n de slots ocupados
- [x] Validaci√≥n de d√≠a cerrado
- [x] Validaci√≥n de especialista no trabaja ese d√≠a
- [x] Soporte multi-sucursal (especialista en varias sucursales)

### ‚úÖ Vistas por Rol
- [x] **Business/Owner**: Vista completa con todas las sucursales
- [x] **Receptionist**: Vista filtrada por sucursal(es) asignadas
- [x] **Specialist**: Agenda combinada de todas sus sucursales
- [x] **Cliente/P√∫blico**: Slots disponibles para reserva

### ‚úÖ Filtros Avanzados
- [x] Por rango de fechas
- [x] Por sucursal
- [x] Por especialista
- [x] Por estado de cita
- [x] Por servicio (para obtener especialistas disponibles)

### ‚úÖ Estad√≠sticas
- [x] Total de citas
- [x] Agrupaci√≥n por estado
- [x] Agrupaci√≥n por sucursal
- [x] Ingresos totales (solo CONFIRMED y COMPLETED)

### ‚úÖ Validaciones
- [x] Validar slot antes de crear cita
- [x] Detectar conflictos de horario
- [x] Verificar disponibilidad de especialista
- [x] Verificar horarios de sucursal

---

## üìã Pr√≥ximos Pasos

### Fase 2A: Completar AppointmentController (Pendiente)
Endpoints que actualmente retornan 501:

1. **updateAppointment()** - `PUT /api/appointments/:id`
   - Actualizar datos de cita
   - Validar disponibilidad si cambia horario
   - Recalcular totalAmount si cambia servicio

2. **completeAppointment()** - `PATCH /api/appointments/:id/complete`
   - Cambiar status a COMPLETED
   - Calcular comisi√≥n (si est√° configurada)
   - Registrar fecha de completado

3. **rescheduleAppointment()** - `POST /api/appointments/:id/reschedule`
   - Validar disponibilidad del nuevo horario
   - Actualizar startTime/endTime
   - Agregar a rescheduleHistory JSONB
   - Mantener o cambiar status

4. **uploadEvidence()** - `POST /api/appointments/:id/evidence`
   - Subir fotos antes/despu√©s
   - Actualizar evidence JSONB
   - Validar que sea el especialista asignado

### Fase 2B: Frontend Web (Solo para Business/Owner)
Recordatorio: Mobile app manejar√° Specialist/Receptionist views

1. **Redux Slices**:
   - `calendarSlice.js` - State para vista de calendario
   - `appointmentSlice.js` - State para CRUD de citas

2. **API Clients**:
   - `calendarApi.js` - Cliente HTTP para calendar endpoints
   - `appointmentApi.js` - Cliente HTTP para appointment endpoints

3. **Componentes UI** (para web-app):
   - `CalendarView.jsx` - Vista principal con FullCalendar
   - `AppointmentModal.jsx` - Crear/editar citas
   - `CalendarFilters.jsx` - Filtros por sucursal/especialista/fecha

4. **Dependencias**:
   ```bash
   npm install @fullcalendar/react @fullcalendar/daygrid @fullcalendar/timegrid @fullcalendar/interaction date-fns
   ```

### Fase 3: Testing
- [ ] Tests de AvailabilityService
  - Intersecci√≥n de horarios
  - Generaci√≥n de slots
  - Detecci√≥n de conflictos
- [ ] Tests de CalendarController
  - Vistas por rol
  - Filtros
  - Estad√≠sticas
- [ ] Tests de integraci√≥n
  - Crear cita ‚Üí Verificar slot ocupado
  - Cancelar cita ‚Üí Verificar slot disponible
  - Multi-sucursal ‚Üí Especialista en 2 sucursales

### Fase 4: Optimizaciones
- [ ] Cach√© de disponibilidad con Redis
- [ ] Invalidaci√≥n de cach√© al crear/cancelar citas
- [ ] Paginaci√≥n para calendarios con muchas citas
- [ ] WebSockets para actualizaci√≥n en tiempo real

---

## üß™ Testing Manual Sugerido

### Test 1: Disponibilidad B√°sica
```http
GET /api/calendar/available-slots?businessId={id}&branchId={id}&specialistId={id}&serviceId={id}&date=2024-01-15
```
**Validar**:
- Retorna slots seg√∫n horario de sucursal
- Respeta horario del especialista
- Duraci√≥n de slots = duraci√≥n del servicio
- Excluye citas existentes

### Test 2: Vista de Negocio
```http
GET /api/calendar/business/{businessId}?startDate=2024-01-01&endDate=2024-01-31
```
**Validar**:
- Retorna citas de todas las sucursales
- Estad√≠sticas correctas
- Eventos formateados para calendario

### Test 3: Especialista Multi-sucursal
```http
GET /api/calendar/specialist/{specialistId}?startDate=2024-01-01&endDate=2024-01-31
```
**Validar**:
- Retorna citas de todas las sucursales del especialista
- Agrupaci√≥n por sucursal (byBranch)

### Test 4: Especialistas Disponibles
```http
GET /api/calendar/branch/{branchId}/specialists?serviceId={id}&date=2024-01-15&time=10:00
```
**Validar**:
- Solo retorna especialistas sin conflictos en ese horario
- Filtra por horario del especialista

---

## üì¶ Archivos del Proyecto

```
packages/backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CalendarController.js ‚úÖ NUEVO
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AvailabilityService.js ‚úÖ NUEVO
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ calendar.js ‚úÖ NUEVO
‚îÇ   ‚îî‚îÄ‚îÄ app.js ‚úÖ ACTUALIZADO
```

---

## üöÄ ¬øC√≥mo Continuar?

### Opci√≥n A: Completar Backend (Recomendado primero)
Completar los endpoints faltantes en `AppointmentController`:
- `updateAppointment()`
- `completeAppointment()`
- `rescheduleAppointment()`
- `uploadEvidence()`

### Opci√≥n B: Comenzar Frontend Web
Crear Redux slices y componentes para la vista web del Business/Owner.

### Opci√≥n C: Testing
Crear tests para validar toda la l√≥gica implementada.

---

**Estado actual**: Backend core del sistema de calendario ‚úÖ COMPLETADO
**Siguiente paso sugerido**: Completar AppointmentController o comenzar con Frontend Web

---

**Fecha**: Octubre 15, 2025  
**Versi√≥n**: 1.0  
**Autor**: Beauty Control Development Team
