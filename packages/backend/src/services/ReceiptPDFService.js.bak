const PDFDocument = require('pdfkit');

/**
 * Servicio para generar PDFs de recibos
 */
class ReceiptPDFService {

  /**
   * Generar PDF de recibo para cliente
   * @param {Object} receipt - Recibo del modelo Receipt
   * @param {Object} business - Negocio
   * @param {Array} items - Items/productos de la venta (opcional)
   * @returns {Promise<Buffer>} - Buffer del PDF generado
   */
  static async generateReceiptPDF(receipt, business, items = []) {
    return new Promise((resolve, reject) => {
      try {
        console.log('üìÑ [ReceiptPDFService] Iniciando generaci√≥n de PDF...');
        // Formato ticket t√©rmico: 80mm width (226.77 points), altura autom√°tica
        const doc = new PDFDocument({ 
          margin: 10,
          size: [226.77, 841.89] // 80mm x ~297mm (se ajusta autom√°ticamente)
        });
        const chunks = [];

        // Capturar el PDF en memoria
        doc.on('data', chunk => {
          chunks.push(chunk);
        });
        
        doc.on('end', () => {
          const pdfBuffer = Buffer.concat(chunks);
          console.log('‚úÖ [ReceiptPDFService] PDF generado, tama√±o:', pdfBuffer.length, 'bytes');
          resolve(pdfBuffer);
        });
        
        doc.on('error', (error) => {
          console.error('‚ùå [ReceiptPDFService] Error en generaci√≥n de PDF:', error);
          reject(error);
        });

        const pageWidth = 226.77; // 80mm
        const centerX = pageWidth / 2;

        // ============= LOGO (si existe) =============
        if (business.logo) {
          try {
            // Intentar cargar el logo (debe ser URL o buffer)
            // Por ahora mostramos el nombre
            doc
              .fontSize(12)
              .font('Helvetica-Bold')
              .text(business.name || 'Beauty Control', 10, 15, { 
                width: pageWidth - 20, 
                align: 'center' 
              });
          } catch (err) {
            // Si falla, mostrar nombre
            doc
              .fontSize(12)
              .font('Helvetica-Bold')
              .text(business.name || 'Beauty Control', 10, 15, { 
                width: pageWidth - 20, 
                align: 'center' 
              });
          }
        } else {
          doc
            .fontSize(12)
            .font('Helvetica-Bold')
            .text(business.name || 'Beauty Control', 10, 15, { 
              width: pageWidth - 20, 
              align: 'center' 
            });
        }

        // Info del negocio
        doc
          .fontSize(7)
          .font('Helvetica')
          .text(business.address || '', { 
            width: pageWidth - 20, 
            align: 'center' 
          })
          .text(`Tel: ${business.phone || 'N/A'}`, { 
            width: pageWidth - 20, 
            align: 'center' 
          });

        if (business.email) {
          doc.text(business.email, { 
            width: pageWidth - 20, 
            align: 'center' 
          });
        }

        doc.moveDown(0.5);

        // L√≠nea separadora
        doc
          .moveTo(10, doc.y)
          .lineTo(pageWidth - 10, doc.y)
          .lineWidth(0.5)
          .stroke()
          .moveDown(0.5);

        // ============= TITULO Y NUMERO DE RECIBO =============
        doc
          .fontSize(10)
          .font('Helvetica-Bold')
          .text('RECIBO DE PAGO', { 
            width: pageWidth - 20, 
            align: 'center' 
          })
          .fontSize(8)
          .text(`N¬∞ ${receipt.receiptNumber}`, { 
            width: pageWidth - 20, 
            align: 'center' 
          })
          .moveDown(0.3);

        // Fecha y hora
        doc
          .fontSize(7)
          .font('Helvetica')
          .text(`Fecha: ${this._formatDate(receipt.createdAt || receipt.date)}`, { 
            width: pageWidth - 20, 
            align: 'center' 
          })
          .text(`Hora: ${this._formatTime(receipt.createdAt || receipt.date)}`, { 
            width: pageWidth - 20, 
            align: 'center' 
          })
          .moveDown(0.5);

        // L√≠nea separadora
        doc
          .moveTo(10, doc.y)
          .lineTo(pageWidth - 10, doc.y)
          .lineWidth(0.5)
          .stroke()
          .moveDown(0.5);

        // ============= CLIENTE =============
        doc
          .fontSize(7)
          .font('Helvetica-Bold')
          .text('CLIENTE', 10, doc.y)
          .moveDown(0.2);

        doc
          .font('Helvetica')
          .fontSize(7)
          .text(`${receipt.clientName}`, 10, doc.y)
          .text(`${receipt.clientPhone || 'N/A'}`, 10, doc.y);

        if (receipt.clientEmail) {
          doc.text(receipt.clientEmail, 10, doc.y);
        }

        doc.moveDown(0.5);

        // ============= SERVICIO/PRODUCTO =============
        if (receipt.serviceName) {
          doc
            .fontSize(7)
            .font('Helvetica-Bold')
            .text('SERVICIO', 10, doc.y)
            .moveDown(0.2);

          doc
            .font('Helvetica')
            .fontSize(7)
            .text(receipt.serviceName, 10, doc.y);

          if (receipt.specialistName) {
            doc.text(`Atendido por: ${receipt.specialistName}`, 10, doc.y);
          }

          doc.moveDown(0.5);
        }

        // L√≠nea separadora
        doc
          .moveTo(10, doc.y)
          .lineTo(pageWidth - 10, doc.y)
          .lineWidth(0.5)
          .stroke()
          .moveDown(0.5);

        // ============= DETALLE =============
        const leftMargin = 10;
        const rightMargin = pageWidth - 10;

        doc
          .fontSize(7)
          .font('Helvetica');

        // Si hay items/productos
        if (items && items.length > 0) {
          items.forEach(item => {
            const name = item.product?.name || item.productName || 'Producto';
            const qty = item.quantity || 1;
            const price = parseFloat(item.unitPrice || 0);
            const itemTotal = parseFloat(item.total || 0);

            // Nombre del producto
            doc.text(`${name}`, leftMargin, doc.y);
            // Cantidad y precio
            doc.text(`  ${qty} x $${this._formatMoney(price)}`, leftMargin, doc.y);
            // Total alineado a la derecha
            doc.text(`$${this._formatMoney(itemTotal)}`, rightMargin - 40, doc.y - 14, { 
              width: 40, 
              align: 'right' 
            });
            doc.moveDown(0.3);
          });
        }

        doc.moveDown(0.3);

        // L√≠nea punteada
        doc
          .fontSize(7)
          .text('- - - - - - - - - - - - - - - - - -', { 
            width: pageWidth - 20, 
            align: 'center' 
          })
          .moveDown(0.3);

        // ============= TOTALES =============
        const subtotal = parseFloat(receipt.subtotal || receipt.totalAmount || 0);
        const discount = parseFloat(receipt.discount || 0);
        const tax = parseFloat(receipt.tax || 0);
        const tip = parseFloat(receipt.tip || 0);
        const total = parseFloat(receipt.totalAmount || 0);

        doc.fontSize(7).font('Helvetica');

        // Subtotal
        if (items && items.length > 0) {
          doc.text(`Subtotal:`, leftMargin, doc.y);
          doc.text(`$${this._formatMoney(subtotal)}`, rightMargin - 50, doc.y - 7, { 
            width: 50, 
            align: 'right' 
          });
          doc.moveDown(0.2);
        }

        // Descuento
        if (discount > 0) {
          doc.text(`Descuento:`, leftMargin, doc.y);
          doc.text(`-$${this._formatMoney(discount)}`, rightMargin - 50, doc.y - 7, { 
            width: 50, 
            align: 'right' 
          });
          doc.moveDown(0.2);
        }

        // Propina
        if (tip > 0) {
          doc.text(`Propina:`, leftMargin, doc.y);
          doc.text(`$${this._formatMoney(tip)}`, rightMargin - 50, doc.y - 7, { 
            width: 50, 
            align: 'right' 
          });
          doc.moveDown(0.2);
        }

        doc.moveDown(0.3);

        // TOTAL (destacado)
        doc
          .fontSize(9)
          .font('Helvetica-Bold')
          .text(`TOTAL:`, leftMargin, doc.y);
        
        doc.text(`$${this._formatMoney(total)}`, rightMargin - 60, doc.y - 9, { 
          width: 60, 
          align: 'right' 
        });

        doc.moveDown(0.5);

        // L√≠nea separadora
        doc
          .moveTo(10, doc.y)
          .lineTo(pageWidth - 10, doc.y)
          .lineWidth(0.5)
          .stroke()
          .moveDown(0.5);

        // ============= METODO DE PAGO =============
        doc
          .fontSize(7)
          .font('Helvetica')
          .text(`M√©todo de pago: ${receipt.paymentMethod || 'Efectivo'}`, { 
            width: pageWidth - 20, 
            align: 'center' 
          });

        // Usuario que registr√≥ el pago
        if (receipt.registeredBy || receipt.user) {
          const userName = receipt.user 
            ? `${receipt.user.firstName} ${receipt.user.lastName}`.trim()
            : 'N/A';
          
          doc
            .text(`Atendido por: ${userName}`, { 
              width: pageWidth - 20, 
              align: 'center' 
            });
        }

        doc.moveDown(0.5);

        // L√≠nea separadora
        doc
          .moveTo(10, doc.y)
          .lineTo(pageWidth - 10, doc.y)
          .lineWidth(0.5)
          .stroke()
          .moveDown(0.5);

        // ============= MENSAJE FINAL =============
        doc
          .fontSize(7)
          .font('Helvetica-Bold')
          .text('¬°Gracias por tu preferencia!', { 
            width: pageWidth - 20, 
            align: 'center' 
          })
          .moveDown(0.3);

        doc
          .fontSize(6)
          .font('Helvetica')
          .text('Conserve este recibo como comprobante de pago', { 
            width: pageWidth - 20, 
            align: 'center' 
          });

        doc.moveDown(1);

        // Finalizar documento
        doc.end();

        // Impuestos (si aplica)
        if (tax > 0) {
          doc
            .text('Impuestos:', leftCol, doc.y)
            .text(`$${this._formatMoney(tax)}`, rightCol, doc.y, { align: 'right' })
            .moveDown(0.3);
        }

        // Propina (si aplica)
        if (tip > 0) {
          doc
            .fillColor('blue')
            .text('Propina:', leftCol, doc.y)
            .text(`$${this._formatMoney(tip)}`, rightCol, doc.y, { align: 'right' })
            .fillColor('black')
            .moveDown(0.3);
        }

        // L√≠nea antes del total
        doc
          .moveDown(0.2)
          .moveTo(100, doc.y)
          .lineTo(500, doc.y)
          .stroke()
          .moveDown(0.5);

        // Total (destacado)
        doc
          .fontSize(14)
          .font('Helvetica-Bold')
          .text('TOTAL:', leftCol, doc.y)
          .text(`$${this._formatMoney(total)}`, rightCol, doc.y, { align: 'right' })
          .moveDown(1);

        // ============= INFORMACI√ìN DEL PAGO =============
        doc
          .fontSize(12)
          .font('Helvetica-Bold')
          .text('INFORMACI√ìN DEL PAGO', { underline: true })
          .moveDown(0.5);

        const paymentMethodNames = {
          CASH: 'Efectivo',
          CARD: 'Tarjeta',
          TRANSFER: 'Transferencia',
          WOMPI: 'Pago en l√≠nea (Wompi)',
          OTHER: 'Otro'
        };

        const paymentStatusNames = {
          PENDING: 'Pendiente',
          PAID: 'Pagado',
          CANCELLED: 'Cancelado',
          REFUNDED: 'Reembolsado'
        };

        doc
          .font('Helvetica')
          .fontSize(10)
          .text(`M√©todo de Pago: ${paymentMethodNames[receipt.paymentMethod] || receipt.paymentMethod}`, 100, doc.y)
          .text(`Estado: ${paymentStatusNames[receipt.paymentStatus]}`, 100, doc.y);

        if (receipt.paymentReference) {
          doc.text(`Referencia: ${receipt.paymentReference}`, 100, doc.y);
        }

        doc
          .text(`Fecha de Emisi√≥n: ${this._formatDateTime(receipt.issueDate)}`, 100, doc.y)
          .moveDown(1.5);

        // ============= C√ìDIGO QR (Opcional) =============
        // Aqu√≠ podr√≠as agregar un c√≥digo QR con la URL de verificaci√≥n del recibo
        // doc.image(qrCodeBuffer, { width: 100, align: 'center' });

        // ============= NOTAS (Si existen) =============
        if (receipt.notes) {
          doc
            .fontSize(10)
            .font('Helvetica-Bold')
            .text('NOTAS:', 100, doc.y)
            .font('Helvetica')
            .fontSize(9)
            .text(receipt.notes, 100, doc.y, { width: 450 })
            .moveDown(1);
        }

        // ============= PIE DE P√ÅGINA =============
        doc
          .moveDown(2)
          .fontSize(8)
          .fillColor('gray')
          .text('¬°Gracias por tu preferencia!', { align: 'center' })
          .moveDown(0.3)
          .text(
            `Este recibo fue generado electr√≥nicamente el ${this._formatDateTime(new Date())}`,
            { align: 'center' }
          )
          .text(' Control de Negocios - Sistema de Gesti√≥n', { align: 'center' });

        // Validaci√≥n de autenticidad
        doc
          .moveDown(0.5)
          .fontSize(7)
          .text(
            `C√≥digo de verificaci√≥n: ${receipt.id.substring(0, 8)}`,
            { align: 'center' }
          );

        // Finalizar el documento
        console.log('üèÅ [ReceiptPDFService] Finalizando documento PDF...');
        doc.end();

      } catch (error) {
        console.error('‚ùå [ReceiptPDFService] Error durante generaci√≥n:', error);
        reject(error);
      }
    });
  }

  /**
   * Formatear fecha (solo d√≠a)
   */
  static _formatDate(date) {
    if (!date) return 'N/A';
    const d = new Date(date);
    return d.toLocaleDateString('es-CO', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  /**
   * Formatear fecha y hora completa
   */
  static _formatDateTime(date) {
    if (!date) return 'N/A';
    const d = new Date(date);
    return d.toLocaleString('es-CO', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  }

  /**
   * Formatear dinero
   */
  static _formatMoney(amount) {
    return new Intl.NumberFormat('es-CO', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }

}

module.exports = ReceiptPDFService;
