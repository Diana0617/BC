import { Linking, Alert } from 'react-native';

/**
 * Utilidades para integraci√≥n WhatsApp b√°sica
 * Genera links de WhatsApp Web para env√≠o de mensajes
 */
class WhatsAppHelper {
  
  /**
   * Formatear n√∫mero de tel√©fono para WhatsApp
   * @param {string} phone - N√∫mero de tel√©fono
   * @returns {string} - N√∫mero formateado para WhatsApp
   */
  static formatPhoneNumber(phone) {
    if (!phone) return '';
    
    // Remover caracteres no num√©ricos
    let cleanPhone = phone.replace(/\D/g, '');
    
    // Si no tiene c√≥digo de pa√≠s, asumir Colombia (+57)
    if (cleanPhone.length === 10 && !cleanPhone.startsWith('57')) {
      cleanPhone = '57' + cleanPhone;
    }
    
    // Si no tiene el + al inicio, agregarlo
    if (!cleanPhone.startsWith('57')) {
      cleanPhone = '57' + cleanPhone;
    }
    
    return cleanPhone;
  }

  /**
   * Generar mensaje de recibo de pago
   * @param {Object} receiptData - Datos del recibo completo
   * @returns {string} - Mensaje formateado
   */
  static generateReceiptMessage(receiptData) {
    // Nueva estructura con modelo Receipt
    if (receiptData.receipt) {
      const { receipt, appointment, business } = receiptData;
      
      const businessName = business?.name || 'Beauty Control';
      const receiptNumber = receipt?.receiptNumber || 'N/A';
      const specialistName = receipt?.specialistName || appointment?.specialist?.name || 'N/A';
      const serviceName = receipt?.serviceName || appointment?.service?.name || 'Servicio';
      const serviceDate = receipt?.serviceDate || appointment?.date || 'N/A';
      const serviceTime = receipt?.serviceTime || appointment?.time || 'N/A';
      const totalAmount = receipt?.totalAmount || appointment?.finalAmount || 0;
      const paymentMethod = receipt?.paymentMethod || 'Wompi';
      const clientName = receipt?.clientName || appointment?.user?.name || 'Cliente';
      
      const formattedAmount = new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(totalAmount);
      
      let message = `¬°Hola ${clientName}! üòä\n\n`;
      message += `Gracias por visitarnos en *${businessName}*.\n\n`;
      message += `üßæ *RECIBO DE PAGO*\n`;
      message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      message += `üìÑ Recibo: *${receiptNumber}*\n`;
      message += `üë§ Especialista: ${specialistName}\n`;
      message += `üíÖ Servicio: ${serviceName}\n`;
      message += `üìÖ Fecha: ${serviceDate}\n`;
      message += `üïê Hora: ${serviceTime}\n`;
      message += `üí∞ Total: ${formattedAmount}\n`;
      message += `üí≥ M√©todo: ${paymentMethod}\n\n`;
      message += `‚úÖ *Pago Confirmado*\n\n`;
      
      if (business?.address) {
        message += `üìç ${business.address}\n`;
      }
      if (business?.phone) {
        message += `üìû ${business.phone}\n`;
      }
      
      message += `\n¬°Gracias por confiar en nosotros! üíñ`;
      
      return message;
    }
    
    // Estructura anterior para compatibilidad
    const {
      businessName,
      serviceName,
      clientName,
      amount,
      date,
      receiptNumber,
      receiptUrl
    } = receiptData;

    const formattedAmount = new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);

    const formattedDate = new Date(date).toLocaleDateString('es-CO', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    let message = `¬°Hola ${clientName}! üòä\n\n`;
    message += `Gracias por visitarnos en *${businessName}*.\n\n`;
    message += `‚úÖ *RECIBO DE PAGO*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìã Servicio: ${serviceName}\n`;
    message += `üí∞ Monto: ${formattedAmount}\n`;
    message += `üìÖ Fecha: ${formattedDate}\n`;
    
    if (receiptNumber) {
      message += `üßæ Recibo: #${receiptNumber}\n`;
    }
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    if (receiptUrl) {
      message += `üìÑ Descarga tu recibo: ${receiptUrl}\n\n`;
    }
    
    message += `¬°Esperamos verte pronto! üíñ\n\n`;
    message += `_Mensaje enviado desde Beauty Control_`;

    return message;
  }

  /**
   * Generar mensaje de confirmaci√≥n de cita
   * @param {Object} appointmentData - Datos de la cita
   * @returns {string} - Mensaje formateado
   */
  static generateAppointmentConfirmationMessage(appointmentData) {
    const {
      businessName,
      serviceName,
      clientName,
      date,
      time,
      specialistName,
      address
    } = appointmentData;

    const formattedDate = new Date(date).toLocaleDateString('es-CO', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    let message = `¬°Hola ${clientName}! üòä\n\n`;
    message += `Tu cita ha sido *confirmada* en *${businessName}*\n\n`;
    message += `üìÖ *DETALLES DE TU CITA*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üíÖ Servicio: ${serviceName}\n`;
    message += `üìÖ Fecha: ${formattedDate}\n`;
    message += `üïê Hora: ${time}\n`;
    
    if (specialistName) {
      message += `üë©‚Äçüíº Especialista: ${specialistName}\n`;
    }
    
    if (address) {
      message += `üìç Direcci√≥n: ${address}\n`;
    }
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `‚è∞ *Recuerda llegar 10 minutos antes*\n\n`;
    message += `Si necesitas reagendar o cancelar, cont√°ctanos lo antes posible.\n\n`;
    message += `¬°Te esperamos! üíñ\n\n`;
    message += `_Mensaje enviado desde Beauty Control_`;

    return message;
  }

  /**
   * Generar URL de WhatsApp con mensaje
   * @param {string} phone - N√∫mero de tel√©fono del destinatario
   * @param {string} message - Mensaje a enviar
   * @returns {string} - URL de WhatsApp
   */
  static generateWhatsAppURL(phone, message) {
    const formattedPhone = this.formatPhoneNumber(phone);
    const encodedMessage = encodeURIComponent(message);
    
    return `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
  }

  /**
   * Abrir WhatsApp con mensaje de recibo
   * @param {string} clientPhone - Tel√©fono del cliente
   * @param {Object} receiptData - Datos del recibo
   */
  static async sendReceiptMessage(clientPhone, receiptData) {
    try {
      if (!clientPhone) {
        Alert.alert('Error', 'No se encontr√≥ el n√∫mero de tel√©fono del cliente');
        return false;
      }

      const message = this.generateReceiptMessage(receiptData);
      const whatsappURL = this.generateWhatsAppURL(clientPhone, message);

      const canOpen = await Linking.canOpenURL(whatsappURL);
      
      if (canOpen) {
        await Linking.openURL(whatsappURL);
        return true;
      } else {
        Alert.alert(
          'WhatsApp no disponible',
          'No se pudo abrir WhatsApp. Aseg√∫rate de tener WhatsApp instalado.',
          [
            { text: 'Copiar mensaje', onPress: () => this.copyToClipboard(message) },
            { text: 'Cancelar', style: 'cancel' }
          ]
        );
        return false;
      }
    } catch (error) {
      console.error('Error opening WhatsApp:', error);
      Alert.alert('Error', 'No se pudo abrir WhatsApp');
      return false;
    }
  }

  /**
   * Abrir WhatsApp con mensaje de confirmaci√≥n de cita
   * @param {string} clientPhone - Tel√©fono del cliente
   * @param {Object} appointmentData - Datos de la cita
   */
  static async sendAppointmentConfirmation(clientPhone, appointmentData) {
    try {
      if (!clientPhone) {
        Alert.alert('Error', 'No se encontr√≥ el n√∫mero de tel√©fono del cliente');
        return false;
      }

      const message = this.generateAppointmentConfirmationMessage(appointmentData);
      const whatsappURL = this.generateWhatsAppURL(clientPhone, message);

      const canOpen = await Linking.canOpenURL(whatsappURL);
      
      if (canOpen) {
        await Linking.openURL(whatsappURL);
        return true;
      } else {
        Alert.alert(
          'WhatsApp no disponible',
          'No se pudo abrir WhatsApp. Aseg√∫rate de tener WhatsApp instalado.',
          [
            { text: 'Copiar mensaje', onPress: () => this.copyToClipboard(message) },
            { text: 'Cancelar', style: 'cancel' }
          ]
        );
        return false;
      }
    } catch (error) {
      console.error('Error opening WhatsApp:', error);
      Alert.alert('Error', 'No se pudo abrir WhatsApp');
      return false;
    }
  }

  /**
   * Copiar texto al portapapeles (requiere react-native-clipboard)
   * @param {string} text - Texto a copiar
   */
  static copyToClipboard(text) {
    // Implementar con react-native-clipboard o expo-clipboard
    // Por ahora solo mostrar el mensaje
    Alert.alert(
      'Mensaje para WhatsApp',
      text,
      [{ text: 'Cerrar' }]
    );
  }

  /**
   * Validar configuraci√≥n de WhatsApp del negocio
   * @param {Object} businessSettings - Configuraci√≥n del negocio
   * @returns {boolean} - Si WhatsApp est√° configurado
   */
  static isWhatsAppConfigured(businessSettings) {
    return !!(
      businessSettings?.notifications?.whatsapp?.enabled &&
      businessSettings?.notifications?.whatsapp?.businessPhone
    );
  }

  /**
   * Obtener configuraci√≥n de WhatsApp del negocio
   * @param {Object} businessSettings - Configuraci√≥n del negocio
   * @returns {Object|null} - Configuraci√≥n de WhatsApp o null
   */
  static getWhatsAppConfig(businessSettings) {
    if (!this.isWhatsAppConfigured(businessSettings)) {
      return null;
    }

    return businessSettings.notifications.whatsapp;
  }

  /**
   * Generar mensaje personalizado
   * @param {string} template - Plantilla del mensaje
   * @param {Object} variables - Variables para reemplazar
   * @returns {string} - Mensaje personalizado
   */
  static generateCustomMessage(template, variables) {
    let message = template;
    
    // Reemplazar variables en formato {{variable}}
    Object.keys(variables).forEach(key => {
      const regex = new RegExp(`{{${key}}}`, 'g');
      message = message.replace(regex, variables[key] || '');
    });
    
    return message;
  }
}

export default WhatsAppHelper;